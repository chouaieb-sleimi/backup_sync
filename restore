#!/usr/bin/env bash
set -e
set -o pipefail

###################
## Restore script for backup_sync

LOG_SUCCESS="success_restore.log"
LOG_ERROR="error_restore.log"
BACKUP_CONF_DEFAULT="$HOME/.backup_config"
TIMESTAMP_START=$(date +%Y-%m-%d_%H-%M-%S)
LOG_FILE=""

############# Functions

display_usage() {
    echo "Usage: restore -p PROFILE [-n] ACTION"
    echo
    echo "ACTION: one of: env | vscode | extensions | config | src | all"
    echo "  env        Restore environment files listed in profile"
    echo "  vscode     Restore VS Code User settings"
    echo "  extensions Install extensions from saved list"
    echo "  config     Restore backup configuration (writes to $BACKUP_CONF_DEFAULT)"
    echo "  src        Restore profile src_folder from backup device"
    echo "  all        Restore env + vscode + extensions + config + src"
    echo
}

display_help() {
    display_usage
    echo "Examples:"
    echo "  restore -p full all"
    echo "  restore -p lite vscode"
}

exit_error() {
    display_usage
    exit 1
}

log() {
    local message=$1
    local timestamp=$(date +%Y-%m-%d_%H:%M:%S)
    echo "$message" >&2
    if [[ -n "$LOG_FILE" ]]; then
        echo "$timestamp | $message" >> "$LOG_FILE"
    fi
}

log_info() { log "[INFO] $1"; }
log_error() { log "[ERROR] $1"; }
log_section() { log "======== $1 ========"; }

confirm() {
    local prompt=${1:-"Are you sure? [y/N] "}
    read -p "$prompt" answer
    answer=${answer:-N}
    [[ $answer == [Yy] ]]
}

read_profile_vars() {
    EXCLUSION_FILE="$BACKUP_CONF/backup_${PROFILE}_exclusion"
    if [[ -f $EXCLUSION_FILE ]]; then
        log_info "Reading exclusion list from: $EXCLUSION_FILE"
    else
        log_error "Exclusion file not found: $EXCLUSION_FILE"
        exit_error
    fi

    VARS_FILE="$BACKUP_CONF/backup_${PROFILE}_vars"
    if [[ -f $VARS_FILE ]]; then
        log_info "Reading backup vars from: $VARS_FILE"
        # shellcheck source=/dev/null
        source $VARS_FILE
    else
        log_error "Variables file not found: $VARS_FILE"
        exit_error
    fi
}

restore_env_files() {
    ENV_FILES_DEST="$DEVICE_PATH/env_files"
    if [[ ! -d $ENV_FILES_DEST ]]; then
        log_error "Env files backup not found at: $ENV_FILES_DEST"
        return 1
    fi

    log_section "RESTORING ENV FILES"
    
    # Check if manifest exists (new format with path preservation)
    manifest="$ENV_FILES_DEST/env_files.manifest"
    if [[ -f $manifest ]]; then
        log_info "Using manifest to restore env files with original paths"
        while IFS='|' read -r base original_path; do
            if [[ -z "$base" || -z "$original_path" ]]; then
                continue
            fi
            
            src="$ENV_FILES_DEST/$base"
            if [[ ! -e $src ]]; then
                log_error "Backup missing for $original_path (expected $src)"
                continue
            fi

            dst_dir=$(dirname "$original_path")
            mkdir -p "$dst_dir"

            if [[ -d $src ]]; then
                log_info "Restoring directory: $original_path"
                rsync_opts=( -av --inplace )
                if [[ $DRY_RUN == true ]]; then rsync_opts+=( --dry-run ); fi
                rsync "${rsync_opts[@]}" "$src/" "$original_path/"
            else
                log_info "Restoring file: $original_path"
                rsync_opts=( -av --inplace )
                if [[ $DRY_RUN == true ]]; then rsync_opts+=( --dry-run ); fi
                rsync "${rsync_opts[@]}" "$src" "$original_path"
            fi
        done < "$manifest"
    else
        # Fallback: use profile env_files array (old format compatibility)
        log_info "No manifest found, using profile env_files array"
        if [[ ${#ENV_FILES[@]} -eq 0 ]]; then
            log_info "No env files configured for profile"
            return 0
        fi

        for file in "${ENV_FILES[@]}"; do
            base=$(basename "$file")
            src="$ENV_FILES_DEST/$base"
            if [[ ! -e $src ]]; then
                log_error "Backup missing for $file (expected $src)"
                continue
            fi

            dst_dir=$(dirname "$file")
            mkdir -p "$dst_dir"

            if [[ -d $src ]]; then
                log_info "Restoring directory $file from $src/ -> $file/"
                rsync_opts=( -av --inplace )
                if [[ $DRY_RUN == true ]]; then rsync_opts+=( --dry-run ); fi
                rsync "${rsync_opts[@]}" "$src/" "$file/"
            else
                log_info "Restoring file $file from $src -> $file"
                rsync_opts=( -av --inplace )
                if [[ $DRY_RUN == true ]]; then rsync_opts+=( --dry-run ); fi
                rsync "${rsync_opts[@]}" "$src" "$file"
            fi
        done
    fi

    log_section "ENV FILES RESTORE COMPLETE"
}

restore_vscode_user() {
    ENV_FILES_DEST="$DEVICE_PATH/env_files"
    src="$ENV_FILES_DEST/vscode/User"
    dst="$HOME/.config/Code/User"

    if [[ ! -d $src ]]; then
        log_error "VS Code user backup not found at: $src"
        return 1
    fi

    log_section "RESTORING VS CODE USER SETTINGS"
    mkdir -p "$dst"
    rsync_opts=( -av --inplace )
    if [[ $DRY_RUN == true ]]; then rsync_opts+=( --dry-run ); fi
    rsync "${rsync_opts[@]}" "$src/" "$dst/"
    log_info "Restored VS Code User settings to $dst"
    log_section "VS CODE RESTORE COMPLETE"
}

restore_extensions_from_list() {
    ENV_FILES_DEST="$DEVICE_PATH/env_files"
    list_file="$ENV_FILES_DEST/vscode/code_extension_list"
    if [[ ! -f $list_file ]]; then
        log_error "Extensions list not found: $list_file"
        return 1
    fi

    log_section "RESTORING VS CODE EXTENSIONS (from list)"
    if [[ $DRY_RUN == true ]]; then
        log_info "Dry-run mode: will print install commands only"
        awk '{print "code --install-extension " $0}' "$list_file"
    else
        # install extensions one per line
        while IFS= read -r ext; do
            if [[ -n $ext ]]; then
                log_info "Installing extension: $ext"
                code --install-extension "$ext" || log_error "Failed to install $ext"
            fi
        done < "$list_file"
    fi
    log_section "EXTENSIONS RESTORE COMPLETE"
}

restore_extensions_binaries() {
    ENV_FILES_DEST="$DEVICE_PATH/env_files"
    src="$ENV_FILES_DEST/vscode/extensions"
    dst="$HOME/.vscode/extensions"

    if [[ ! -d $src ]]; then
        log_error "Extensions binary backup not found at: $src"
        return 1
    fi

    log_section "RESTORING VS CODE EXTENSION BINARIES"
    mkdir -p "$dst"
    rsync_opts=( -av --inplace )
    if [[ $DRY_RUN == true ]]; then rsync_opts+=( --dry-run ); fi
    rsync "${rsync_opts[@]}" "$src/" "$dst/"
    log_section "EXTENSION BINARIES RESTORE COMPLETE"
}

restore_config() {
    log_section "RESTORING BACKUP CONFIG"
    src="$DEVICE_PATH/backup_config"
    # restore config into the local default config location (not the active BACKUP_CONF which may point to device)
    dst="$BACKUP_CONF_DEFAULT"

    if [[ ! -d $src ]]; then
        log_error "Packaged backup config not found at: $src"
        return 1
    fi

    log_info "About to restore backup config from $src -> $dst"
    if [[ $DRY_RUN == true ]]; then
        rsync -avn --inplace "$src/" "$dst/"
    else
        mkdir -p "$dst"
        if confirm "This will overwrite or create files in $dst. Proceed? [y/N] "; then
            rsync -av --inplace --delete "$src/" "$dst/"
            log_info "Restored backup configuration to $dst"
        else
            log_info "Skipped restoring backup configuration"
        fi
    fi
    log_section "CONFIG RESTORE COMPLETE"
}

restore_src_folder() {
    log_section "RESTORING SRC FOLDER"
    src="$DEVICE_PATH/$DEV_DEST_FOLDER/"
    dst="$SRC_FOLDER/"

    if [[ ! -d $DEVICE_PATH/$DEV_DEST_FOLDER ]]; then
        log_error "Backup of source folder not found at: $DEVICE_PATH/$DEV_DEST_FOLDER"
        return 1
    fi

    log_info "About to rsync from $src -> $dst"
    if [[ $DRY_RUN == true ]]; then
        rsync -avn --inplace --delete --exclude-from=$EXCLUSION_FILE "$src" "$dst"
    else
        # prompt for confirmation before overwriting local files
        if confirm "This will overwrite files in $dst. Proceed? [y/N] "; then
            rsync -av --inplace --delete --exclude-from=$EXCLUSION_FILE "$src" "$dst"
            log_info "Restored source folder to $dst"
        else
            log_info "Skipped restoring source folder"
        fi
    fi
    log_section "SRC RESTORE COMPLETE"
}

### Main
DRY_RUN=false
PROFILE=""

while getopts :p:hn option; do
    case $option in
        p) PROFILE=$OPTARG ;;
        n) DRY_RUN=true ;;
        h) display_help; exit 0 ;;
        :) echo "Missing argument for -$OPTARG"; exit_error ;;
        ?) echo "Unknown option -$OPTARG"; exit_error ;;
    esac
done

shift $((OPTIND-1))

ACTION=${1:-}

if [[ -z $PROFILE || -z $ACTION ]]; then
    display_usage
    exit 1
fi

read -p "Device name [$DEFAULT_DEVICE_NAME]: " device_name
DEVICE_NAME=${device_name:-"$DEFAULT_DEVICE_NAME"}
DEVICE_PATH="/run/media/$USER/$DEVICE_NAME"
LOG_FILE="$DEVICE_PATH/restore_$TIMESTAMP_START.log"

if [[ ! -d $DEVICE_PATH ]]; then
    log_error "Backup device not found at: $DEVICE_PATH"
    exit 1
fi

# If the device contains a packaged backup config, use it for reading profile vars.
if [[ -d "$DEVICE_PATH/backup_config" ]]; then
    BACKUP_CONF="$DEVICE_PATH/backup_config"
    log_info "Using packaged backup config from: $BACKUP_CONF"
else
    BACKUP_CONF="$BACKUP_CONF_DEFAULT"
    log_info "Using local backup config at: $BACKUP_CONF"
fi

# Now read profile vars from the selected BACKUP_CONF
read_profile_vars

# With profile vars loaded, derive DEST_FOLDER (depends on DEV_DEST_FOLDER)
DEST_FOLDER="$DEVICE_PATH/$DEV_DEST_FOLDER"

log_section "STARTING RESTORE"
log_info "Profile: $PROFILE"
log_info "Device: $DEVICE_PATH"
log_info "Action: $ACTION"

case $ACTION in
    env)
        restore_env_files
        ;;
    vscode)
        restore_vscode_user
        ;;
    extensions)
        restore_extensions_from_list
        ;;
    config)
        restore_config
        ;;
    extensions-bin)
        restore_extensions_binaries
        ;;
    src)
        restore_src_folder
        ;;
    all)
        restore_env_files
        restore_vscode_user
        restore_extensions_from_list
        restore_src_folder
        ;;
    *)
        echo "Unknown action: $ACTION"
        display_usage
        exit 1
        ;;
esac

log_section "RESTORE COMPLETE"

exit 0
